@model HlidacStatu.Lib.Data.Firma

@using Nest;
@using HlidacStatu.Lib.Render;
@using HlidacStatu.Web.Framework;
@using System.Collections.Generic;
@using System.Linq;

@section breadcrumb
{
    <ol class="breadcrumb">
        <li><a href="/">Hlídač Státu</a></li>
        <li>Úřady a firmy</li>
        <li class="active">@ViewBag.Title</li>
    </ol>
}


<style>
    .my-0 {
        margin-top: 0px;
        margin-bottom: 0px;
    }

    .py-0 {
        padding-top: 0px;
        padding-bottom: 0px;
    }

    .boxes h4 {
        font-size: 24px;
        font-weight: bold;
    }

    .head h3 {
        font-size: 40px;
        font-weight: bold;
    }

    p {
        font-size: 16px;
    }

    .watcher .btn {
        background-color: rgb(231,102,5);
        padding: 7px 15px;
        margin: 5px 0px;
        text-transform: none;
        font-size: 14px;
    }
</style>

<div class="head">
    <h3>@Model.ObecneJmeno()</h3>
    <p>Úřad - orgán veřejné moci. Řídí <a>45 podřízených organizací.</a> Je součástí <a>14 kategorií orgánu veřejné moci.</a></p>
</div>
<hr />

<div class="row boxes">
    @* První sloupec *@
    <div class="col-sm-7">
        @* ----- K-Index ----- *@
        @using (Html.ShowKIndex(this.User))
        {
            HlidacStatu.Lib.Analysis.KorupcniRiziko.KIndexData kidx = HlidacStatu.Lib.Analysis.KorupcniRiziko.KIndex.Get(Model.ICO);
            if (kidx != null && kidx.LastKIndexLabel() != HlidacStatu.Lib.Analysis.KorupcniRiziko.KIndexData.KIndexLabelValues.None)
            {
                <div>
                    <h4>K-Index</h4>

                    <p class=" muted">
                        Index korupčního rizika - zkráceně K–Index, je ukazatel míry rizikových faktorů. Tyto faktory jsou spojovány s rizikem korupce a nehospodárným nakládáním veřejných peněz.
                    </p>
                    <a href="/kindex/detail/@Model.ICO">
                        <img src="/socialbanner/kindex?v=@Model.ICO" style="width:40%;max-width:500px;min-width:150px;height:auto" />
                    </a>
                    <br />
                    <a href="/kindex/detail/@Model.ICO">Jak jsme @Html.KIndexIcon(Model.ICO) spočítali podrobně popisujeme zde</a>
                    <br />
                    @WebUtil.FeedbackUniversal("Přepočítat K-Index",
                    "Pokud jste upravili své smlouvy v registru smluv, můžete si nechat přepočítat svůj K-Index. Přepočítání může trvat v závislosti na vytížení našich serverů několik dní. Pro přepočítání musíte být zaregistrováni.",
                    "Důvod pro přepočítání",
                    "Přepočítat K-Index",
                    "/kindex/recalculateFeedback",
                    mustAuth: true,
                    addData: Model.ICO)
                </div>
                <hr />
            }
        }


        @* ----- Registr smluv ----- *@

    <div>
        <h4>Registr smluv</h4>

        @{
            var currentYear = DateTime.Now.Year;
            var numFatalIssue = HlidacStatu.Lib.Data.Smlouva.Search.SimpleSearch($"ico:{Model.ICO} AND chyby:zasadni AND cena:0 AND datumUzavreni:[{currentYear}-01-01 TO {currentYear + 1}-01-01}}", 0, 0, HlidacStatu.Lib.Data.Smlouva.Search.OrderResult.FastestForScroll, exactNumOfResults: true).ElasticResults.HitsMetadata.Total;
            var numVazneIssue = HlidacStatu.Lib.Data.Smlouva.Search.SimpleSearch($"ico:{Model.ICO} AND chyby:vazne AND cena:0 AND datumUzavreni:[{currentYear}-01-01 TO {currentYear + 1}-01-01}}", 0, 0, HlidacStatu.Lib.Data.Smlouva.Search.OrderResult.FastestForScroll, exactNumOfResults: true).ElasticResults.HitsMetadata.Total;
        }
        @if (numFatalIssue.Value > 0)
        {
            <p>
                Zásadní nedostatky za letošní rok v rozporu se zákonem jsme zjistili u
                <a class="text-danger" href="/hledatsmlouvy?q=ico:@(Model.ICO)+AND+chyby:zasadni AND cena:0 AND datumUzavreni:[@(currentYear)-01-01 TO @(currentYear + 1)-01-01}">
                    @if (numFatalIssue.Relation == TotalHitsRelation.GreaterThanOrEqualTo)
                    {
                        @Html.Raw(Devmasters.Lang.Plural.GetWithZero((int)numFatalIssue.Value, "<u><strong>0 </strong>smluv</u>.", "<u><strong>jedné </strong>smlouvy</u>.", "<u><strong>{0} </strong>smluv</u>.", "<u><strong>více než {0:### ### ##0} </strong>smluv</u>.")) }
                    else
                    {
                        @Html.Raw(Devmasters.Lang.Plural.GetWithZero((int)numFatalIssue.Value, "<u><strong>0 </strong>smluv</u>.", "<u><strong>jedné </strong>smlouvy</u>.", "<u><strong>{0} </strong>smluv</u>.", "<u><strong>{0:### ### ##0} </strong>smluv</u>."))
                    }
                    Tyto smlouvy jsou velmi pravděpodobně neplatné.
                </a>
            </p>
        }
        @if (numVazneIssue.Value > 0)
        {
            <p>
                @if (numFatalIssue.Value == 0)
                {
                    <span>Vážné nedostatky za letošní rok jsme zjistili u</span>
                }
                else
                {
                    <span>Zároveň vážné nedostatky za letošní rok jsme zjistili u</span>
                }

                <a class="text-danger" href="/hledatsmlouvy?q=ico:@(Model.ICO)+AND+chyby:vazne AND cena:0 AND datumUzavreni:[@(currentYear)-01-01 TO @(currentYear + 1)-01-01}">
                    @if (numFatalIssue.Relation == TotalHitsRelation.GreaterThanOrEqualTo)
                    {
                        @Html.Raw(Devmasters.Lang.Plural.GetWithZero((int)numVazneIssue.Value, "<u><strong>0 </strong>smluv</u>.", "<u><strong>jedné </strong>smlouvy</u>.", "<u><strong>{0} </strong>smluv</u>.", "<u><strong>více než {0:### ### ##0} </strong>smluv</u>.")) }
                    else
                    {
                        @Html.Raw(Devmasters.Lang.Plural.GetWithZero((int)numVazneIssue.Value, "<u><strong>0 </strong>smluv</u>.", "<u><strong>jedné </strong>smlouvy</u>.", "<u><strong>{0} </strong>smluv</u>.", "<u><strong>{0:### ### ##0} </strong>smluv</u>."))
                    }
                </a>
            </p>
        }

        @{ 
            int rsLastYear = Model.Statistic().BasicStatPerYear.LastYear;
            var rsLatestData = Model.Statistic().BasicStatPerYear.Data[rsLastYear];
            int rsRatingLastYear = Model.Statistic().RatingPerYear.LastYear;
            var rsLatestRating = Model.Statistic().RatingPerYear.Data[rsRatingLastYear];

            int rsPreviousYear = rsLastYear - 1;
            decimal? rsPercentageVolumeIncrease = null;
            if(Model.Statistic().BasicStatPerYear.Data.TryGetValue(rsPreviousYear, out var rsPenultimateData))
            {
                rsPercentageVolumeIncrease = rsLatestData.CelkemCena / rsPenultimateData.CelkemCena * 100;
            }
        }
        
        <p>V roce @rsLastYear uzavřel úřad 
            <a href="/hledat?q=ico:@(Model.ICO) AND cena:0 AND datumUzavreni:[@(rsLastYear)-01-01 TO @(rsLastYear + 1)-01-01}"><strong>@rsLatestData.Pocet</strong> smluv</a>
            za <strong>@(Html.Raw(HlidacStatu.Lib.Data.Smlouva.NicePrice(rsLatestData.CelkemCena, html: true, shortFormat: true)))</strong>
            @( rsPercentageVolumeIncrease.HasValue ? $"({rsPercentageVolumeIncrease?.ToString("N2")} % rozpočtu za {rsPreviousYear})" :"" ) 
        </p>

        <p>V @rsRatingLastYear utajil hodnotu kontraktu u <a href="/hledat?q=ico:@(Model.ICO) AND cena:0 AND datumUzavreni:[@(rsRatingLastYear)-01-01 TO @(rsRatingLastYear + 1)-01-01}"><strong>@rsLatestRating.NumBezCeny</strong> smluv</a>, což je celkem @rsLatestRating.PercentBezCeny.ToString("N2") % ze všech.</p>
        <a class="text-uppercase"><strong>Zobrazit podrobnosti</strong></a>
    </div>
        <hr />

        @* ----- Veřejné zakázky -----*@

        <div>
            <h4>Veřejné zakázky</h4>
            <a class="text-uppercase"><strong>Zobrazit podrobnosti</strong></a>
        </div>
        <hr />
        <div>
            <h4>Dotace</h4>
            <a class="text-uppercase"><strong>Zobrazit podrobnosti</strong></a>
        </div>
        <hr />
        <div>
            <h4>Insolvenční rejstřík</h4>
            <a class="text-uppercase"><strong>Zobrazit podrobnosti</strong></a>
        </div>
        <hr />
        <div>
            <h4>Obchody úřadu s firmami navázanými na politiky</h4>
            <a class="text-uppercase"><strong>Zobrazit podrobnosti</strong></a>
        </div>
        <hr />
        <div>
            <h4>Statistika dodavatelů úřadu</h4>
            <a class="text-uppercase"><strong>Zobrazit podrobnosti</strong></a>
        </div>
        <hr />
        <div>
            <h4>Statistiky odběratelů úřadu</h4>
            <a class="text-uppercase"><strong>Zobrazit podrobnosti</strong></a>
        </div>
        <hr />
        <div>
            <h4>Úřad v dalších databázích</h4>
            <a class="text-uppercase"><strong>Zobrazit podrobnosti</strong></a>
        </div>
    </div>
    @* Prázdný sloupec *@
    <div class="col-sm-1">
    </div>
    @* Pravý sloupec *@
    <div class="col-sm-4">
        <div class="row">
            <div class="col-sm-4">
                <div class="person-profile-thumb">
                    <div class="photo">
                        <div class="profile-picture" style="background-image: url('https://www.hlidacstatu.cz/Photo/alena-schillerova')"></div>
                    </div>
                </div>
            </div>
            <div class="col-sm-8">
                <p class="py-0 my-0 text-muted">Aktuální ministr</p>
                <p class="py-0 my-0 lead">JUDr. Alena Schillerová, Ph.D</p>
                <p class="py-0 my-0">od 13. 12. 2017</p>
            </div>
        </div>
        <hr />
        <div>
            <table>
                <tr>
                    <td class="text-nowrap text-muted col-sm-5">Založeno</td>
                    <td class="col-sm-7">21.4.1988</td>
                </tr>
                <tr>
                    <td class="text-nowrap text-muted col-sm-5">IČO</td>
                    <td class="col-sm-7">00007064</td>
                </tr>
                <tr>
                    <td class="text-nowrap text-muted col-sm-5">Datová schránka</td>
                    <td class="col-sm-5">meiq7wd, xzeaauv</td>
                </tr>
            </table>
        </div>
        <hr />
        <div class="watcher">
            <h4>Chci hlídat</h4>
            <div>
                <a href="#" class="btn btn-warning btn-xs">
                    <span class="glyphicon glyphicon-eye-open"></span>
                    <span class="btn-emphasized">Všechny změny o ministerstvo financí</span>
                </a>
            </div>
            <div>
                <a href="#" class="btn btn-warning btn-xs">
                    <span class="glyphicon glyphicon-eye-open"></span>
                    <span class="btn-emphasized">Změny i v 45 dceřiných společnostech</span>
                </a>
            </div>
        </div>
        <hr />
        <div>
            <span class="text-muted">Chci sdílet s ostatními</span>
            <div>
                <a href="#" class="ssk ssk-text ssk-facebook ssk-xs" target="_blank" data-ssk-ready="true">na Facebook</a>
                <a href="#" class="ssk ssk-text ssk-twitter ssk-xs" target="_blank" data-ssk-ready="true">na Twitter</a>
            </div>
        </div>
    </div>
</div>