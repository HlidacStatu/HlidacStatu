@model string
@using System
@using System.Collections.Generic
@using System.Linq
@using HlidacStatu.Web.Models
@using Devmasters.Collections

@{
    Layout = null;


    var clientQ = NemocniceOnlyData.Client()
        .Search<NemocniceOnlyData>(s => s
            .Query(q => q.QueryString(qs => qs.Query($"datum:[{DateTime.Now.AddDays(-60):yyyy-MM-dd} TO *]")))
            .Size(2000)
            .Sort(so => so.Descending(a => a.datum))
    );
    NemocniceOnlyData[] nemocnice = clientQ
        .Hits
        .Select(m => m.Source)
        .ToArray();

    var kraje = nemocnice.Select(m => m.kraj_nazev).Distinct();

    string[] prefered = new string[] { "Hlavní město Praha", "Středočeský kraj", "Jihomoravský kraj", "Moravskoslezský kraj" };
    List<string> krajeSort = prefered
    .Union(kraje
        .Where(m => prefered.Contains(m) == false)
        .OrderBy(m => m)
        )
    .ToList();


}



<script>
    var hs = parseInt(window.location.hash.replace("#", ""));
    if (Number.isInteger(hs)) {
        window.location.replace("/kapacitaKazdeNemocnice/" + hs);
    }
</script>


<div class="jumbotron">
    <h2 style="padding-bottom:40px;" class="text-center">
        Volné kapacity intenzivní péče v jednotlivých nemocnicích, změny v čase
    </h2>
    <p>
        Data o kapacitách nemocnic, která Ministerstvo zdravotnictví tají před veřejností.  <span class="exclusive">Nové</span>
    </p>

</div>

<div class="bs-callout bs-callout-primary small">
    <h4>Základní pojmy</h4>
    <p>
        <dl>
            <dt>COVID lůžka</dt>
            <dd>
                Lůžka speciálně vyhrazena pro infekční pacienty. Kromě obvykle fyzické izolace ve vyhrazeném prostoru je zde
                povinná vyšší ochrana lékařů a sester (ochranný oblek), obvykle kratší směny, speciální režim zaměstnanců.
            </dd>
            <dt>neCOVID lůžka</dt>
            <dd>
                Obvyklá JIP/ARO/lůžka s kyslíkem, bez jinak obvyklého speciálního režimu.
                Podle možností nemocnice je možné některá z těchto lůžek změnit na COVID lůžka.
                To má samozřejmě vliv třeba na léčbu těch, které přivezou od dopravní nehody
            </dd>

        </dl>
    </p>
</div>


@if (string.IsNullOrEmpty(Model))
{
    <div class="row">
        <div class="col-xs-12">
            <h3>Vyberte si v seznamu nemocnici, pro kterou chcete znát aktuální kapacitu</h3>
        </div>
    </div>
}
else
{
    <div class="row">
        <div class="col-xs-12">
            @RenderH(Model)
        </div>
    </div>
    <hr />
}
<h4>Rychlá navigace</h4>
<div class="row">
    <div class="col-xs-12">
        <ul>
            <li><a href="/kapacitanemocnic">Aktuální kapacity pro celé kraje</a></li>
        </ul>
    </div>
    <div class="col-xs-12">Seznam nemocnic po krajích:</div>

    @foreach (var chk in krajeSort.Chunk(7))
    {
        int count = 0;
        foreach (var k in chk)
        {
            count++;
            <div class="col-xs-12 col-sm-6">
                <ul>
                    <li>
                        <b>@k</b>
                        <ul>
                            @foreach (var h in nemocnice.Where(m => m.kraj_nazev == k).Select(m => new { zz_id = m.zz_id, zz_nazev = m.zz_nazev }).Distinct().OrderBy(o => o.zz_nazev))
                            {
                                <li><a href="/KapacitaKazdeNemocnice/@h.zz_id">@h.zz_nazev</a></li>
                            }
                        </ul>
                    </li>
                </ul>
            </div>
            if (count % 2 == 0)
            {
                <div class="clearfix"></div>
            }
        }
    }
    <div class="col-xs-12">
        <hr />
        <ul>
            <li><a href="/kapacitanemocnic">Aktuální kapacity pro celé kraje</a></li>
            <li><a href="/kapacitanemocnic#nemocnice">Tabulka aktuálních kapacit jednotlivých nemocnic</a></li>
        </ul>
    </div>
</div>



<h2 id="opendata">Open Data</h2>
<ul>
    <li><a href="/data/index/kapacity-nemocnic" target="_blank">Data se statistikami po krajich</a></li>
    <li><a href="/KapacitaNemocnicData/last" target="_blank">Aktuální stav kapacit jednotlivých nemocnic</a></li>
</ul>


@functions { public string TColor(int val)
    {
        if (val < 0)
        {
            return "#A00000";
        }
        else if (val > 0)
        {
            return "#00A000";
        }
        else
        {
            return "#000000";
        }
    }

}

@helper RenderH(string nemocniceId)
{
var hdataQ = NemocniceOnlyData.Client().Search<NemocniceOnlyData>(s => s
.Query(q => q.QueryString(qs => qs.Query($"datum:[{DateTime.Now.AddDays(-60):yyyy-MM-dd} TO *] AND zz_id.keyword:{nemocniceId}")))
   .Size(80)
   .Sort(so => so.Descending(a => a.datum))
);
NemocniceOnlyData[] hdata = hdataQ.Hits
.Select(m => m.Source)
.ToArray();



var chartdata = hdata.OrderBy(o => o.zz_kod)
    .Select(m => new
    {
        date = m.datum,
        data = m
    });
//NemocniceOnlyData first = chartdata.Last().data;

NemocniceOnlyData h = hdata.First();

    <h2 id="@h.zz_kod">@h.zz_nazev</h2>
    <p class="text-info">Data v grafu jsou vybraná jednotlivá hlášení nemocnic do systému DIP. Každá nemocnice reportuje v jiný čas a různě často.</p>

    <div class="row">
        <div class="col-xs-12 col-sm-6 singlebox">
            <h4>Lůžka (ARO+JIP dospělí)</h4>
            <p>
                Celkem @h.luzka_aro_jip_kapacita_celkem, volných @(h.luzka_aro_jip_kapacita_volna_covid_pozitivni+h.luzka_aro_jip_kapacita_volna_covid_negativni) (@HlidacStatu.Util.RenderData.NicePercent(h.luzka_aro_jip_kapacita_perc()))
                <br />
                Volná lůžka: COVID <span style="font-size:125%;font-weight:bold">@h.luzka_aro_jip_kapacita_volna_covid_pozitivni</span> / neCOVID <span style="font-size:125%">@h.luzka_aro_jip_kapacita_volna_covid_negativni</span>
                @*<br />
                    Změna volných od @first.lastModified.ToString("dd.MM."): <span style="font-weight:normal;color:@TColor(diffH.AROJIP_luzka_covid)">@(diffH.AROJIP_luzka_covid.ToString("+#;-#;0"))</span> / <span style="font-weight:normal;color:@TColor(diffH.AROJIP_luzka_necovid)">@(diffH.AROJIP_luzka_necovid.ToString("+#;-#;0"))</span>*@
            </p>
            <p>
                @UtilChart.SimpleLineChart(new (string name, IEnumerable<HlidacStatu.Lib.Render.ReportDataTimeValue> values)[] {
                        (name:"ARO+JIP volná neCOVID lůžka",
                            values:chartdata.Select(m=>new HlidacStatu.Lib.Render.ReportDataTimeValue(){ Date = m.date, Value = m.data.luzka_aro_jip_kapacita_volna_covid_negativni } )
                        ),
                        (name:"ARO+JIP volná COVID lůžka",
                            values:chartdata.Select(m=>new HlidacStatu.Lib.Render.ReportDataTimeValue(){ Date = m.date, Value = m.data.luzka_aro_jip_kapacita_volna_covid_pozitivni } )
                        ),
                        (name:"ARO+JIP COVID lůžka celkem",
                            values:chartdata.Select(m=>new HlidacStatu.Lib.Render.ReportDataTimeValue(){ Date = m.date, Value = m.data.luzka_aro_jip_kapacita_celkem } )
                        )
                    },
                    "", "počet", 200, minY: 0)
            </p>
        </div>
        <div class="clearfix hidden-md hidden-lg"></div>

        <div class="col-xs-12 col-sm-6 singlebox">
            <h4>Lůžka (standardní s kyslíkem)</h4>
            <p>
                Celkem @h.luzka_standard_kyslik_kapacita_celkem, volných @(h.luzka_standard_kyslik_kapacita_volna_covid_pozitivni+h.luzka_standard_kyslik_kapacita_volna_covid_negativni) (@HlidacStatu.Util.RenderData.NicePercent(h.luzka_standard_kyslik_kapacita_perc()))
                <br />
                Volná lůžka: COVID <span style="font-size:125%;font-weight:bold">@h.luzka_standard_kyslik_kapacita_volna_covid_pozitivni</span> / neCOVID <span style="font-size:125%">@h.luzka_standard_kyslik_kapacita_volna_covid_negativni</span>
                @*<br />
                    Změna volných od @first.lastUpdated.ToString("dd.MM."): <span style="font-weight:normal;color:@TColor(diffH.Standard_luzka_s_kyslikem_covid)">@(diffH.Standard_luzka_s_kyslikem_covid.ToString("+#;-#;0"))</span> / <span style="font-weight:normal;color:@TColor(diffH.Standard_luzka_s_kyslikem_necovid)">@(diffH.Standard_luzka_s_kyslikem_necovid.ToString("+#;-#;0"))</span>*@
            </p>
            <p>
                @UtilChart.SimpleLineChart(new (string name, IEnumerable<HlidacStatu.Lib.Render.ReportDataTimeValue> values)[] {
                        (name:"volná neCOVID lůžka s kyslíkem",
                            values:chartdata.Select(m=>new HlidacStatu.Lib.Render.ReportDataTimeValue(){ Date = m.date, Value = m.data.luzka_standard_kyslik_kapacita_volna_covid_negativni} )
                        ),
                        (name:"volná COVID lůžka s kyslíkem",
                            values:chartdata.Select(m=>new HlidacStatu.Lib.Render.ReportDataTimeValue(){ Date = m.date, Value = m.data.luzka_standard_kyslik_kapacita_volna_covid_pozitivni} )
                        ),
                        (name:"COVID lůžka s kyslíkem celkem",
                            values:chartdata.Select(m=>new HlidacStatu.Lib.Render.ReportDataTimeValue(){ Date = m.date, Value = m.data.luzka_standard_kyslik_kapacita_celkem} )
                        )                },
                    "", "počet", 200, minY: 0)
            </p>
        </div>
        <div class="clearfix "></div>

        <div class="col-xs-12 col-sm-6 singlebox">
            <h4>Přístroje ECMO <small>podpora nejvaznejsich pripadu, plicni rizeni</small></h4>

            <p>
                Celkem @h.ecmo_kapacita_celkem, volných: @h.ecmo_kapacita_volna (@HlidacStatu.Util.RenderData.NicePercent(h.ecmo_kapacita_perc()))
                @*<br />
                    Změna volných od @first.lastUpdated.ToString("dd.MM."): <span style="font-weight:normal;color:@TColor(diffH.ECMO_volna)">@(diffH.ECMO_volna.ToString("+#;-#;0"))</span>*@
            </p>
            <p>
                @UtilChart.SimpleLineChart(new (string name, IEnumerable<HlidacStatu.Lib.Render.ReportDataTimeValue> values)[] {
                        (name:"Přístroje ECMO celkem",
                            values:chartdata.Select(m=>new HlidacStatu.Lib.Render.ReportDataTimeValue(){ Date = m.date, Value = m.data.ecmo_kapacita_celkem } )
                        ),
                        (name:"Přístroje ECMO volné",
                            values:chartdata.Select(m=>new HlidacStatu.Lib.Render.ReportDataTimeValue(){ Date = m.date, Value = m.data.ecmo_kapacita_volna } )
                        )
                    },
                    "", "počet", 200, minY: 0)
            </p>
        </div>
        <div class="clearfix hidden-md hidden-lg"></div>

        <div class="col-xs-12 col-sm-6 singlebox">
            <h4>Přístroje UPV <small>Umělá plicni ventilace</small></h4>
            <p>
                Celkem @h.upv_kapacita_celkem, volných: @h.upv_kapacita_volna (@HlidacStatu.Util.RenderData.NicePercent(h.upv_kapacita_perc()))
                @*<br />
                    Změna volných od @first.lastUpdated.ToString("dd.MM."): <span style="font-weight:normal;color:@TColor(diffH.UPV_volna)">@(diffH.UPV_volna.ToString("+#;-#;0"))</span>*@
            </p>
            <p>
                @UtilChart.SimpleLineChart(new (string name, IEnumerable<HlidacStatu.Lib.Render.ReportDataTimeValue> values)[] {
                        (name:"Přístroje UPV celkem",
                            values:chartdata.Select(m=>new HlidacStatu.Lib.Render.ReportDataTimeValue(){ Date = m.date, Value = m.data.upv_kapacita_celkem } )
                        ),
                        (name:"Přístroje UPV volné",
                            values:chartdata.Select(m=>new HlidacStatu.Lib.Render.ReportDataTimeValue(){ Date = m.date, Value = m.data.upv_kapacita_volna } )
                        )
                    },
                    "", "počet", 200, minY: 0)
            </p>

        </div>

        <div class="clearfix"></div>

        <div class="col-xs-12 col-sm-6 singlebox">
            <h4>Přístroje CRRT <small>kontinuální dialýza</small></h4>
            <p>
                Celkem @h.crrt_kapacita_celkem, volných: @h.crrt_kapacita_volna (@HlidacStatu.Util.RenderData.NicePercent(h.crrt_kapacita_perc()))
                @*<br />
                    Změna volných od @first.lastUpdated.ToString("dd.MM."): <span style="font-weight:normal;color:@TColor(diffH.CRRT_volna)">@(diffH.CRRT_volna.ToString("+#;-#;0"))</span>*@
            </p>
            <p>
                @UtilChart.SimpleLineChart(new (string name, IEnumerable<HlidacStatu.Lib.Render.ReportDataTimeValue> values)[] {
                        (name:"Přístroje CRRT celkem",
                            values:chartdata.Select(m=>new HlidacStatu.Lib.Render.ReportDataTimeValue(){ Date = m.date, Value = m.data.crrt_kapacita_celkem } )
                        ),
                        (name:"Přístroje CRRT volné",
                            values:chartdata.Select(m=>new HlidacStatu.Lib.Render.ReportDataTimeValue(){ Date = m.date, Value = m.data.crrt_kapacita_volna } )
                        )
                    },
                    "", "počet", 200, minY: 0)
            </p>
        </div>

        <div class="col-xs-12 col-sm-6 singlebox">
            <h4>Dostupné ventilátory <small>přenosné + operační sál</small></h4>
            <p>
                Celkem @(h.ventilatory_prenosne_kapacita_celkem+h.ventilatory_operacni_sal_kapacita_celkem)
                <br />
                @*Změna počtu od @first.lastUpdated.ToString("dd.MM."): <span style="font-weight:normal;color:@TColor((diffH.Ventilatory_prenosne_celkem+diffH.Ventilatory_operacnisal_celkem))">@((h.Ventilatory_prenosne_celkem+h.Ventilatory_operacnisal_celkem).ToString("+#;-#;0"))</span>
                    <br />*@
            </p>
            <p>
                @UtilChart.SimpleLineChart(new (string name, IEnumerable<HlidacStatu.Lib.Render.ReportDataTimeValue> values)[] {
                        (name:"Dostupné ventilátory přenosné+oper.sál",
                            values:chartdata.Select(m=>new HlidacStatu.Lib.Render.ReportDataTimeValue(){ Date = m.date, Value = m.data.ventilatory_prenosne_kapacita_celkem+m.data.ventilatory_operacni_sal_kapacita_celkem } )
                        )
                    },
                    "", "počet", 200, minY: 0)
            </p>
        </div>

        <div class="clearfix"></div>

    </div>
    <hr />

}

@functions {

}