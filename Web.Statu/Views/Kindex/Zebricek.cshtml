@model IEnumerable<SubjectWithKIndex>

@using Devmasters.Core;
@using HlidacStatu.Lib.Analysis.KorupcniRiziko;
@using HlidacStatu.Web.Framework;
@using System.Linq;
@using System.Text.RegularExpressions;

@{

    int selectedYear = ViewBag.SelectedYear;
    string selectedGroup = ViewBag.SelectedGroup;

    ViewBag.Title = ViewBag.LadderTitle + " pro " + ViewBag.SelectedYear;
    ViewBag.HideTitle = true;

    List<string> filterGroups = Model.Select(c => c.Group).Distinct().ToList();

}

@section scripts
{

}

@section breadcrumb
{
    <ol class="breadcrumb">
        <li><a href="/">Hlídač Státu</a></li>
        <li>K–Index</li>
        <li class="active">@ViewBag.Title</li>
    </ol>
}

<style>
    .whisp {
        width: 600px;
        text-align: left;
        background: white;
        border-left: 2px grey solid;
        border-top: 0px;
        border-bottom: 1px grey dotted;
        border-right: 0px grey solid;
        padding-bottom: 2px;
    }

    #companies {
        margin-bottom: 10px;
    }
</style>

<h2>@(ViewBag.LadderTitle) pro rok @ViewBag.SelectedYear</h2>

<div class="row">
    <div class="col-sm-12">
        <h3 class="">
            Žebříček pro další roky:
            @for (int year = DateTime.Now.Year - 1; year > 2016; year--)
            {
                if (year != selectedYear)
                {
                    <a style="padding-right:20px;" href="@(ViewBag.SelectedLadder)?rok=@year&group=@selectedGroup"><i class="fas fa-arrow-square-right"></i> @year</a>
                }
                else
                {
                    <span style="padding-right:20px;"><i class="far fa-arrow-square-right"></i> @year</span>
                }
            }
        </h3>
    </div>
</div>

@* TODO:
    + přidat hodnotu pro zobrazení všech hodnot*@
@if(filterGroups.Count > 2 || Model.Count() > 10)
{
    <h2>@(string.IsNullOrEmpty(selectedGroup) ? "Nebyla vybrána žádná skupina" : $"Pro skupinu: {selectedGroup}")</h2>
    <div class="row">
        <div class="col-sm-12">
            <h3 class="">
                Skupiny podle kterých lze filtrovat:
                @if (string.IsNullOrEmpty(selectedGroup))
                {
                    <span style="padding-right:20px;"><i class="far fa-arrow-square-right"></i>Zobrazit vše</span>
                }
                else
                {
                    <a style="padding-right:20px;" href="@(ViewBag.SelectedLadder)?rok=@selectedYear"><i class="fas fa-arrow-square-right"></i>Zobrazit vše</a>
                }
                @foreach (var group in filterGroups)
                {
                    if (group != selectedGroup)
                    {
                        <a style="padding-right:20px;" href="@(ViewBag.SelectedLadder)?group=@group&rok=@selectedYear"><i class="fas fa-arrow-square-right"></i>@group</a>
                    }
                    else
                    {
                        <span style="padding-right:20px;"><i class="far fa-arrow-square-right"></i>@group</span>
                    }
                }
            </h3>
        </div>
    </div>
}


<hr style="width:1px" />
<div class="row">
    <div class="col-sm-12">

        <table class="table table-striped table-dotted table-condensed table-hover">
            <thead>
                <tr>
                    <th>Pořadí</th>
                    <th>Známka</th>
                    <th>Firma</th>
                    <th style="text-align: right;">Body</th>
                    @*<td>Přidat do porovnání</td>*@
                </tr>
            </thead>
            <tbody>
                @foreach (var record in Model.Where(r => r.KIndex != HlidacStatu.Lib.Analysis.KorupcniRiziko.Consts.MinSmluvPerYearKIndexValue).Select((m, i) => new { rank = i + 1, item = m }))
                {
                    <tr>
                        <td>
                            @(record.rank).
                        </td>
                        <td>
                            @Html.KIndexLabelLink(record.item.Ico, showNone: true, rok: selectedYear)
                        </td>
                        <td>
                            <a href="/subjekt/@record.item.Ico">@record.item.Jmeno</a>
                        </td>
                        <td class="number">
                            @(record.item.KIndex.ToString("F2"))
                        </td>
                        @*<td></td>*@
                    </tr>
                }
            </tbody>
        </table>
        <hr />
        <div>
            <p>K-Index nebyl spočítán pro následující organizace, které mají méně než @(Consts.MinSmluvPerYear) smluv za rok nebo malý objem smluv.</p>
            <p>
                @{
                    string[] rest = Model
                        .Where(r => r.KIndex == HlidacStatu.Lib.Analysis.KorupcniRiziko.Consts.MinSmluvPerYearKIndexValue)
                        .Select(r => $"<a href=\"/subjekt/{r.Ico} \">{r.Jmeno}</a>").ToArray();
                } 
                
                @Html.Raw(string.Join(" | ", rest)) 
                
            </p>
        </div>

    </div>
</div>

<script>


</script>