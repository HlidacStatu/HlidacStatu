@model IEnumerable<SubjectWithKIndex>

@using Devmasters.Enums;
@using HlidacStatu.Lib.Analysis.KorupcniRiziko;
@using HlidacStatu.Web.Framework;
@using System.Linq;
@using System.Text.RegularExpressions;

@{

    Layout = null;

    int selectedYear = ViewBag.SelectedYear;
    string selectedGroup = ViewBag.SelectedGroup;
    string selectedKraj = ViewBag.SelectedKraj;
    KIndexData.KIndexParts? part = (KIndexData.KIndexParts?)ViewBag.SelectedPart;
    string partDesc = part.HasValue ? "pro " + part.Value.ToNiceDisplayName() : "";


    var data = Model.ToArray().Where(m => true);

    if (!string.IsNullOrEmpty(selectedGroup))
    {
        data = data.Where(c => string.IsNullOrEmpty(selectedGroup) || selectedGroup == c.Group);
    }

    if (!string.IsNullOrEmpty(selectedKraj))
    {
        data = data.Where(c => string.IsNullOrEmpty(selectedKraj) || selectedKraj == c.Kraj);
    }



    string filterUrlValue = "group";
    Dictionary<string, int> filterGroups = Model
        .GroupBy(k => k.Group, v => v, (k, v) => new { group = k, count = v.Count() })
        .ToDictionary(k => k.group, c => c.count);
    if (filterGroups.Count < 2)
    {
        filterUrlValue = "kraj";
        filterGroups = Model
            .GroupBy(k => k.Kraj, v => v, (k, v) => new { group = k, count = v.Count() })
        .ToDictionary(k => k.group, c => c.count);

    }


    ViewBag.Title = ViewBag.LadderTitle + " pro " + ViewBag.SelectedYear;
    if (filterUrlValue == "group" && !string.IsNullOrEmpty(selectedGroup))
    {
        ViewBag.SubTitle = $"pro skupinu {selectedGroup}";
    }
    else if (!string.IsNullOrEmpty(selectedKraj))
    {
        ViewBag.SubTitle = $"pro kraj {selectedKraj}";
    }
    ViewBag.HideTitle = true;


}

@section scripts
{

}

@section breadcrumb
{
    <ol class="breadcrumb">
        <li><a href="/">Hlídač Státu</a></li>
        <li><a href="/kindex">K–Index</a></li>
        <li><a href="/kindex/zebricek">Žebříčky úřadů a organizací</a></li>
        <li class="active">@(ViewBag.Title + " " + ViewBag.SubTitle) @partDesc</li>
    </ol>
}

<h2>@(ViewBag.LadderTitle) pro rok @ViewBag.SelectedYear<small>@ViewBag.SubTitle @partDesc</small></h2>

<div class="row">
    <div class="col-sm-12">
        <h3 class="">
            Žebříček pro další roky:
            @foreach (int year in Consts.CalculationYears)
            {
                if (year != selectedYear)
                {
                    <a style="padding-right:20px;" href="@(ViewBag.SelectedLadder)?rok=@year&kraj=@System.Net.WebUtility.UrlEncode(selectedKraj)&group=@System.Net.WebUtility.UrlEncode(selectedGroup)"><i class="fas fa-arrow-square-right"></i> @year</a>
                }
                else
                {
                    <span style="padding-right:20px;"><i class="far fa-arrow-square-right"></i> @year</span>
                }
            }
        </h3>
    </div>
</div>

@if (filterGroups.Count > 1 && Model.Count() > 10)
{

    <div class="row">
        <div class="col-sm-12">
            <h4 class="">
                Skupiny, podle kterých lze filtrovat:
            </h4>
            <div>
                @if (string.IsNullOrEmpty(selectedGroup))
                {
                    @*<span style="padding-right:20px;"><i class="far fa-arrow-square-right"></i>Zobrazeno vše</span>*@
                }
                else
                {
                    <a style="padding-right:20px;" href="@(ViewBag.SelectedLadder)?rok=@selectedYear"><i class="fas fa-arrow-square-right"></i>Zrušit filter, zobrazit vše</a>
                }
                @foreach (var group in filterGroups)
                {
                    if (group.Key == selectedGroup)
                    {
                        <span style="padding-right:20px;font-weight:bold"><i class="fas fa-arrow-square-right"></i>@group.Key (@group.Value)</span>
                    }
                    else if (group.Key == selectedKraj)
                    {
                        <span style="padding-right:20px;font-weight:bold"><i class="fas fa-arrow-square-right"></i>@group.Key (@group.Value)</span>
                    }
                    else
                    {
                        <span style="padding-right:20px;">
                            <a href="@(ViewBag.SelectedLadder)?@filterUrlValue=@System.Net.WebUtility.UrlEncode(group.Key)&rok=@selectedYear"><i class="fas fa-arrow-square-right"></i>@group.Key </a>(@group.Value)
                        </span>
                    }
                }
            </div>
        </div>
    </div>
    <hr/>
}


<hr style="width:1px" />
<div class="row">
    <div class="col-sm-12">

        <table class="table table-striped table-dotted table-hover">
            <thead>
                <tr>
                    <th>Pořadí</th>
                    <th>Známka @partDesc</th>
                    <th>Firma</th>
                    <th style="text-align: right;">Body @partDesc</th>
                    @*<td>Přidat do porovnání</td>*@
                </tr>
            </thead>
            <tbody>
                @foreach (var record in data
                    .Where(r => !( r.KIndex == HlidacStatu.Lib.Analysis.KorupcniRiziko.Consts.MinSmluvPerYearKIndexValue 
                            || r.KIndex == 0
                        )
                        
                    )
                    .Select((m, i) => new { rank = i + 1, item = m })
                    )
                {
                    <tr>
                        <td>
                            @(record.rank).
                        </td>
                        <td>
                            @if (part.HasValue)
                            {
                                var lbl = KIndexData.KIndexLabelForPart(part.Value, record.item.KIndex);
                                @Html.KIndexLabelLink(record.item.Ico, lbl,"height:15px;" )
                            }
                            else
                            {
                                @Html.KIndexLabelLink(record.item.Ico, showNone: true, rok: selectedYear)
                            }
                        </td>
                        <td>
                            <a href="/subjekt/@record.item.Ico">@record.item.Jmeno</a>
                        </td>
                        <td class="number">
                            @(record.item.KIndex.ToString("F2"))
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        <hr />
        <div>
            @{
                string[] rest = data
                    .Where(r => r.KIndex == HlidacStatu.Lib.Analysis.KorupcniRiziko.Consts.MinSmluvPerYearKIndexValue || r.KIndex==0 )
                    .Select(r => Html.KIndexIcon(KIndexData.KIndexLabelValues.None, 15, showNone: true).ToHtmlString()
                        + $"<a href=\"/subjekt/{r.Ico} \">{r.Jmeno}</a>"
                    ).ToArray();
            }
            <p>K-Index nebyl spočítán pro @(rest.Count() > 1 ? "následující" : "" ) organizace, které mají méně než @(Consts.MinSmluvPerYear) smluv za rok nebo malý objem smluv.</p>
            <p>

                @Html.Raw(string.Join(", ", rest))

            </p>
        </div>

    </div>
</div>

<script>


</script>